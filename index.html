<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triotrack</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        :root {
            --primary: #0d9488; --primary-light: #ccfbf1; --secondary: #0f766e;
            --bg-light: #f8fafc; --text-light: #334155; --card-light: #ffffff;
            --bg-dark: #0f172a; --text-dark: #f1f5f9; --card-dark: #1e293b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg-light); color: var(--text-light); overflow-x: hidden; }
        
        .hidden { display: none !important; }
        .flex { display: flex; } .flex-col { flex-direction: column; } .items-center { align-items: center; } .justify-between { justify-content: space-between; }
        .w-full { width: 100%; } .h-full { height: 100%; }
        .p-4 { padding: 1rem; } .p-6 { padding: 1.5rem; } .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .font-bold { font-weight: 700; } .text-center { text-align: center; }
        .text-xl { font-size: 1.25rem; } .text-sm { font-size: 0.875rem; } .text-xs { font-size: 0.75rem; }
        .rounded-xl { border-radius: 0.75rem; } .rounded-full { border-radius: 9999px; }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .bg-white { background-color: white; } .bg-primary { background-color: var(--primary); } .text-white { color: white; } .text-primary { color: var(--primary); }
        .border { border: 1px solid #e2e8f0; }

        /* Loading Screen */
        #loading-screen { position: fixed; inset: 0; background: white; z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Component Styles */
        .nav-glass { position: fixed; top: 0; width: 100%; height: 56px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); z-index: 50; border-bottom: 1px solid #eee; }
        .logo-3d-text { font-weight: 900; color: var(--primary); letter-spacing: -1px; }
        .card-simple { background: white; border: 1px solid #e2e8f0; border-radius: 1.5rem; height: 100px; display: flex; align-items: center; justify-content: center; font-weight: 800; cursor: pointer; transition: 0.2s; }
        .card-simple:hover { border-color: var(--primary); background: var(--primary-light); color: var(--secondary); transform: translateY(-2px); }
        
        /* Map Styles */
        #map { width: 100%; height: 100%; border-radius: 1.5rem; z-index: 0; }
        .bus-marker-icon { width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.3); font-size: 20px; }

        /* Input Group */
        .input-group { background: #f1f5f9; padding: 0.75rem 1rem; border-radius: 0.75rem; display: flex; align-items: center; margin-top: 0.25rem; }
        input { background: transparent; border: none; outline: none; width: 100%; font-size: 1rem; }

        .max-w-md { max-width: 28rem; margin: 0 auto; }
        .pt-20 { padding-top: 5rem; }
        .min-h-screen { min-height: 100vh; }
    </style>
</head>
<body class="light">

    <div id="loading-screen">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; font-weight: bold; color: #64748b;">Loading Triotrack...</p>
    </div>

    <nav class="nav-glass">
        <div class="max-w-md mx-auto px-4 flex justify-between items-center h-full">
            <div class="flex items-center gap-2" onclick="window.navigateTo('welcome')" style="cursor: pointer;">
                <span class="logo-3d-text text-xl">TRIOTRACK</span>
            </div>
            <button onclick="window.navigateTo('admin')" class="text-xs font-bold text-gray-500 border rounded-full px-3 py-1">Admin</button>
        </div>
    </nav>

    <main class="pt-20 pb-10 px-4 max-w-md mx-auto min-h-screen relative flex flex-col">
        
        <section id="view-welcome" class="view flex-col flex flex-grow">
            <div class="mt-8 text-center">
                <h1 class="logo-3d-text" style="font-size: 3rem;">TRIOTRACK</h1>
                <p class="text-sm font-bold uppercase text-primary">Find , Route , Track</p>
            </div>
            <div class="flex justify-center my-8">
                 <svg width="200" height="140" viewBox="0 0 300 200" fill="none"><path d="M20 60 C20 40 40 40 60 40 L240 40 C260 40 280 60 280 140 L280 160 L20 160 L20 60 Z" fill="#0d9488" /><rect x="20" y="60" width="260" height="50" fill="#1e293b" /><circle cx="70" cy="160" r="22" fill="#334155" /><circle cx="230" cy="160" r="22" fill="#334155" /></svg>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md border text-center">
                <p class="text-sm text-gray-500">Connecting travelers with real-time bus locations.</p>
                <p id="db-status" class="mt-2 text-xs font-bold text-orange-500">Connecting to Cloud...</p>
            </div>
            <div class="mt-auto mb-4">
                <button onclick="window.navigateTo('selection')" class="w-full bg-primary text-white font-bold py-4 rounded-xl shadow-md">Get Started</button>
            </div>
        </section>

        <section id="view-admin" class="view hidden">
            <button onclick="window.navigateTo('welcome')" class="mb-4 text-sm font-bold text-gray-500">‚Üê Back</button>
            <h2 class="text-2xl font-bold mb-6 text-primary">Admin Login</h2>
            <div class="bg-white p-6 rounded-xl shadow-md border">
                <div class="mb-4"><label class="text-xs font-bold uppercase">Email</label><div class="input-group"><input type="email" id="admin-email"></div></div>
                <div class="mb-6"><label class="text-xs font-bold uppercase">Password</label><div class="input-group"><input type="password" id="admin-password"></div></div>
                <button onclick="window.adminLogin()" class="w-full bg-primary text-white font-bold py-3 rounded-xl">Login</button>
            </div>
        </section>

        <section id="view-selection" class="view hidden">
            <button onclick="window.navigateTo('welcome')" class="mb-4 text-sm font-bold text-gray-500">‚Üê Back</button>
            <h2 class="text-2xl font-bold mb-6 text-primary">Select Category</h2>
            <div class="grid grid-cols-2" style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                <div onclick="window.selectCategory('Private')" class="card-simple">Private</div>
                <div onclick="window.selectCategory('Transport')" class="card-simple">Transport</div>
            </div>
        </section>

        <section id="view-search" class="view hidden">
            <button onclick="window.navigateTo('selection')" class="mb-4 text-sm font-bold text-gray-500">‚Üê Back</button>
            <h2 class="text-2xl font-bold text-primary mb-6" id="search-header">Find Route</h2>
            <div class="bg-white p-6 rounded-xl shadow-md border">
                <div class="mb-4"><label class="text-xs font-bold uppercase">From</label><div class="input-group"><input type="text" id="input-from" list="locations" placeholder="Palakkad"></div></div>
                <div class="mb-6"><label class="text-xs font-bold uppercase">To</label><div class="input-group"><input type="text" id="input-to" list="locations" placeholder="Guruvayur"></div></div>
                <button onclick="window.showBusResults()" class="w-full bg-primary text-white font-bold py-3 rounded-xl">Search Buses</button>
            </div>
        </section>

        <section id="view-results" class="view hidden">
            <button onclick="window.navigateTo('search')" class="mb-4 text-sm font-bold text-gray-500">‚Üê Back</button>
            <div id="results-list" class="flex flex-col gap-4"></div>
        </section>

        <section id="view-live-map" class="view hidden flex flex-col h-screen" style="height: 80vh;">
             <div class="flex justify-between items-center mb-2">
                 <h2 class="text-xl font-bold text-primary">Live Tracking</h2>
                 <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded font-bold">‚óè LIVE</span>
             </div>
             <p class="text-xs text-gray-500 mb-4" id="map-bus-id">Connecting...</p>
             
             <div class="relative w-full flex-grow rounded-3xl overflow-hidden border border-gray-300">
                 <div id="map"></div> 
             </div>
             
             <button onclick="window.navigateTo('results')" class="mt-4 w-full bg-gray-100 text-gray-600 font-bold py-3 rounded-xl">Exit Map</button>
        </section>

    </main>

    <datalist id="locations"><option value="Palakkad"><option value="Guruvayur"><option value="Ottapalam"><option value="Thrissur"></datalist>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // YOUR CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDcWwo0m2eS1ndyC06U1G_JF1J7Y1WNlfQ",
            authDomain: "triotrack-66dd6.firebaseapp.com",
            projectId: "triotrack-66dd6",
            storageBucket: "triotrack-66dd6.firebasestorage.app",
            messagingSenderId: "994389952848",
            appId: "1:994389952848:web:659fbc330f2d660dfb0455",
            measurementId: "G-B7TMFX0F21"
        };

        // Initialize
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            // If we reached here, Firebase loaded. Remove loading screen.
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('db-status').innerText = "‚óè Ready";
            document.getElementById('db-status').className = "mt-2 text-xs font-bold text-green-600";

            // --- VARIABLES ---
            let map, busMarker, unsubscribeLive;
            let busRoutesDB = [
                { id: "p1", type: "Private", stops: ["Palakkad", "Ottapalam", "Guruvayur"], buses: [{ id: "KL-55-A", start: "07:00", type: "Fast" }] }
            ];

            // --- MAP FUNCTION ---
            window.initMap = (busId) => {
                if (!map) {
                    map = L.map('map', { zoomControl: false }).setView([10.7867, 76.6548], 12);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map);
                    const busIcon = L.divIcon({ className: '', html: '<div class="bus-marker-icon">üöå</div>', iconSize: [40, 40], iconAnchor: [20, 20] });
                    busMarker = L.marker([10.7867, 76.6548], { icon: busIcon }).addTo(map);
                }
                
                // Live Listener
                if(unsubscribeLive) unsubscribeLive();
                unsubscribeLive = onSnapshot(doc(db, "live_locations", busId), (doc) => {
                    if (doc.exists()) {
                        const d = doc.data();
                        const loc = [d.lat, d.lng];
                        busMarker.setLatLng(loc);
                        map.flyTo(loc, 15);
                        document.getElementById('map-bus-id').innerText = `Bus ${busId} ‚Ä¢ ${Math.round(d.speed||0)} km/h`;
                    }
                });
                setTimeout(() => map.invalidateSize(), 300);
            };

            // --- NAVIGATION ---
            window.navigateTo = (viewId) => {
                document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
                const target = document.getElementById('view-' + viewId);
                if(target) target.classList.remove('hidden');
                
                if (viewId === 'live-map') window.initMap('KL-55-A');
                else if (unsubscribeLive) unsubscribeLive();
            };

            // --- OTHER LOGIC ---
            window.selectCategory = (cat) => { 
                document.getElementById('search-header').innerText = `Find ${cat} Route`; 
                window.navigateTo('search'); 
            };

            window.showBusResults = () => {
                const list = document.getElementById('results-list'); 
                list.innerHTML = '';
                busRoutesDB[0].buses.forEach(bus => {
                    const div = document.createElement('div');
                    div.className = "bg-white p-5 rounded-xl shadow-md border cursor-pointer mb-2";
                    div.innerHTML = `<div class="flex justify-between items-center"><h3 class="font-bold text-lg text-primary">${bus.id}</h3><span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded">LIVE TRACK</span></div>`;
                    div.onclick = () => window.navigateTo('live-map');
                    list.appendChild(div);
                });
                window.navigateTo('results');
            };

            window.adminLogin = async () => {
                const e = document.getElementById('admin-email').value;
                const p = document.getElementById('admin-password').value;
                try {
                    await signInWithEmailAndPassword(auth, e, p);
                    alert("Login Success");
                } catch(err) { alert(err.message); }
            };

        } catch (error) {
            console.error(error);
            alert("Critical Error: " + error.message);
        }
    </script>
</body>
</html>
