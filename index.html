<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triotrack - Live Bus Tracking</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    
    <style>
        /* =========================================
           CORE VARIABLES & THEME
           ========================================= */
        :root {
            --primary: #0d9488;       /* Teal-600 */
            --primary-light: #ccfbf1; /* Teal-50 */
            --secondary: #0f766e;     /* Teal-700 */
            --accent: #f59e0b;        /* Amber-500 */
            
            --bg-light: #f8fafc;      /* Slate-50 */
            --text-light: #334155;    /* Slate-700 */
            --card-light: #ffffff;
            
            --bg-dark: #0f172a;       /* Slate-900 */
            --text-dark: #f1f5f9;     /* Slate-100 */
            --card-dark: #1e293b;     /* Slate-800 */

            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 1.5rem;
        }

        html.dark { --bg-current: var(--bg-dark); --text-current: var(--text-dark); --card-current: var(--card-dark); --border-current: #334155; }
        html.light { --bg-current: var(--bg-light); --text-current: var(--text-light); --card-current: var(--card-light); --border-current: #e2e8f0; }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-current);
            color: var(--text-current);
            transition: all 0.3s ease;
            overflow-x: hidden; /* Prevents side scrolling breaks */
        }

        /* UTILITIES */
        .hidden { display: none !important; }
        .flex { display: flex; } .flex-col { flex-direction: column; }
        .items-center { align-items: center; } .justify-between { justify-content: space-between; }
        .w-full { width: 100%; } .h-full { height: 100%; }
        .fixed { position: fixed; } .absolute { position: absolute; } .relative { position: relative; }
        
        /* Spacing */
        .p-4 { padding: 1rem; } .p-6 { padding: 1.5rem; } .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .mt-4 { margin-top: 1rem; } .mb-4 { margin-bottom: 1rem; } .mb-6 { margin-bottom: 1.5rem; }
        .gap-2 { gap: 0.5rem; } .gap-4 { gap: 1rem; }

        /* Typography */
        .text-center { text-align: center; } .font-bold { font-weight: 700; }
        .text-xs { font-size: 0.75rem; } .text-xl { font-size: 1.25rem; } .text-2xl { font-size: 1.5rem; } .text-5xl { font-size: 3rem; }
        .uppercase { text-transform: uppercase; }

        /* Shapes */
        .rounded-xl { border-radius: 0.75rem; } .rounded-2xl { border-radius: 1rem; } .rounded-full { border-radius: 9999px; }
        .shadow-md { box-shadow: var(--shadow); }
        .border { border: 1px solid var(--border-current); }

        /* Colors */
        .bg-white { background-color: var(--card-current); }
        .bg-primary { background-color: var(--primary); }
        .text-primary { color: var(--primary); } .text-white { color: #ffffff; } .text-gray-500 { color: #64748b; }

        /* LOADING SCREEN */
        #loading-screen {
            position: fixed; inset: 0; background: var(--bg-current); z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #e2e8f0; 
            border-top: 5px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* LAYOUT HELPERS */
        .max-w-md { max-width: 28rem; margin: 0 auto; }
        .min-h-screen { min-height: 100vh; }
        .pt-28 { padding-top: 7rem; } /* Account for fixed header */

        /* COMPONENTS */
        .nav-glass {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            height: 56px; width: 100%; top: 0; z-index: 50; position: fixed;
        }
        html.dark .nav-glass { background: rgba(15, 23, 42, 0.9); border-color: rgba(255,255,255,0.1); }

        .datetime-bar {
            position: fixed; top: 56px; left: 0; width: 100%; height: 32px;
            background: var(--card-light); z-index: 40;
            border-bottom: 1px solid var(--border-current);
            display: flex; justify-content: center; align-items: center; gap: 1rem;
            font-size: 0.75rem; font-weight: 700; color: var(--primary);
        }
        html.dark .datetime-bar { background: var(--card-dark); }

        .logo-3d-text {
            font-weight: 900; color: var(--primary);
            text-shadow: 1px 1px 0px #115e59; letter-spacing: -1px;
        }

        .card-simple {
            background: var(--card-current); border: 1px solid var(--border-current);
            border-radius: 1.5rem; height: 100px; display: flex; align-items: center; justify-content: center;
            font-weight: 800; cursor: pointer; transition: all 0.2s;
        }
        .card-simple:hover { border-color: var(--primary); background: var(--primary-light); color: var(--secondary); }

        .input-group {
            display: flex; align-items: center; background-color: #f1f5f9;
            border-radius: 0.75rem; padding: 0.75rem 1rem;
        }
        html.dark .input-group { background-color: rgba(255,255,255,0.05); }
        input { background: transparent; border: none; outline: none; width: 100%; color: var(--text-current); font-size: 1rem; }

        /* MAP STYLES */
        #map { width: 100%; height: 100%; border-radius: 1.5rem; z-index: 0; }
        .map-container { position: relative; width: 100%; height: 500px; border-radius: 1.5rem; overflow: hidden; border: 1px solid var(--border-current); }
        .bus-marker-icon {
            width: 40px; height: 40px; background: var(--primary); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 3px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            color: white; font-size: 20px;
        }

        /* ICONS */
        .icon-sm { width: 16px; height: 16px; fill: currentColor; }
    </style>
</head>
<body class="light">

    <div id="loading-screen">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; font-weight: bold; color: var(--primary);">Connecting to Triotrack...</p>
    </div>

    <nav class="nav-glass">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center h-full">
            <div class="flex items-center gap-2" onclick="window.navigateTo('welcome')" style="cursor: pointer;">
                <span class="logo-3d-text text-xl">TRIOTRACK</span>
            </div>
            <button onclick="window.navigateTo('admin')" class="text-xs font-bold text-gray-500 border rounded-full px-3 py-1 hover:text-primary">Admin</button>
        </div>
    </nav>
    <div class="datetime-bar">
        <span id="live-time">--:--</span>
        <span style="opacity: 0.3;">|</span>
        <span id="live-date">Loading...</span>
    </div>

    <main class="pt-28 pb-10 px-4 max-w-md mx-auto min-h-screen relative flex flex-col">
        
        <section id="view-welcome" class="view flex-col flex flex-grow">
            <div class="mt-8 text-center" style="padding-top: 20px;">
                <h1 class="logo-3d-text text-5xl mb-4">TRIOTRACK</h1>
                <p class="text-sm font-bold uppercase text-primary">Find , Route , Track</p>
            </div>

            <div class="flex justify-center my-8">
                <svg width="240" height="160" viewBox="0 0 300 200" fill="none">
                    <path d="M20 60 C20 40 40 40 60 40 L240 40 C260 40 280 60 280 140 L280 160 L20 160 L20 60 Z" fill="#0f766e" />
                    <rect x="20" y="60" width="260" height="50" fill="#1e293b" />
                    <circle cx="70" cy="160" r="22" fill="#334155" /><circle cx="230" cy="160" r="22" fill="#334155" />
                </svg>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-md border relative z-10 text-justify">
                <p class="text-sm text-gray-500 leading-relaxed">
                    Triotrack is a smart platform for real-time bus tracking. Use the search to find your route and track buses live.
                </p>
                <p id="db-status" class="text-center mt-4 text-xs font-bold text-orange-500">Connecting to Cloud...</p>
            </div>

            <div class="mt-auto mb-4">
                <button onclick="window.navigateTo('selection')" class="w-full bg-primary text-white font-bold py-4 rounded-xl shadow-md">Get Started</button>
            </div>
        </section>

        <section id="view-selection" class="view hidden">
            <button onclick="window.navigateTo('welcome')" class="mb-4 text-sm font-bold text-gray-500">‚Üê Back</button>
            <h2 class="text-2xl font-bold mb-6 text-primary">Select Category</h2>
            <div class="grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div onclick="window.selectCategory('Private')" class="card-simple">Private</div>
                <div onclick="window.selectCategory('Transport')" class="card-simple">Transport</div>
                <div onclick="window.selectCategory('Interstate')" class="card-simple">Interstate</div>
                <div onclick="window.navigateTo('institution')" class="card-simple">Institution</div>
            </div>
        </section>

        <section id="view-search" class="view hidden">
            <button onclick="window.navigateTo('selection')" class="mb-4 text-sm font-bold text-gray-500">‚Üê Back</button>
            <h2 class="text-2xl font-bold text-primary mb-6" id="search-header">Find Route</h2>
            <div class="bg-white p-6 rounded-2xl shadow-md border">
                <div class="mb-4">
                    <label class="text-xs font-bold uppercase">From</label>
                    <div class="input-group mt-1"><input type="text" id="input-from" list="locations" placeholder="Palakkad"></div>
                </div>
                <div class="mb-6">
                    <label class="text-xs font-bold uppercase">To</label>
                    <div class="input-group mt-1"><input type="text" id="input-to" list="locations" placeholder="Guruvayur"></div>
                </div>
                <button onclick="window.showBusResults()" class="w-full bg-primary text-white font-bold py-3 rounded-xl shadow-md">Search Buses</button>
            </div>
        </section>

        <section id="view-results" class="view hidden">
            <button onclick="window.navigateTo('search')" class="mb-4 text-sm font-bold text-gray-500">‚Üê Back</button>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-primary">Buses Found</h2>
                <div id="result-count" class="text-xs font-bold bg-primary text-white px-2 py-1 rounded">0</div>
            </div>
            <div id="results-list" class="flex flex-col gap-4"></div>
        </section>

        <section id="view-live-map" class="view hidden flex flex-col h-full pt-4">
             <div class="text-center mb-2">
                 <h2 class="text-xl font-bold text-primary">Live Tracking</h2>
                 <p class="text-xs text-gray-500" id="map-bus-id">Connecting...</p>
             </div>

             <div class="map-container">
                 <div id="map"></div> <div class="absolute top-3 right-3 bg-white px-2 py-1 rounded shadow text-xs font-bold text-green-600 z-[1000]">‚óè LIVE GPS</div>
             </div>
             
             <button onclick="window.navigateTo('results')" class="mt-4 w-full bg-red-50 text-red-500 font-bold py-3 rounded-xl">Exit Map</button>
        </section>

        <section id="view-institution" class="view hidden">
            <button onclick="window.navigateTo('selection')" class="mb-4 text-sm font-bold text-gray-500">‚Üê Back</button>
            <h2 class="text-2xl font-bold mb-4 text-primary">Polytechnic Colleges</h2>
            <div class="mb-4">
                 <select id="district-select" onchange="window.loadColleges()" class="w-full p-3 rounded-xl border bg-white">
                     <option value="" disabled selected>Choose District</option>
                     <option value="Palakkad">Palakkad</option>
                     <option value="Thrissur">Thrissur</option>
                 </select>
            </div>
            <div id="college-list" class="flex flex-col gap-4"></div>
        </section>

        <section id="view-admin" class="view hidden">
            <button onclick="window.navigateTo('welcome')" class="mb-4 text-sm font-bold text-gray-500">‚Üê Back</button>
            <h2 class="text-2xl font-bold mb-6 text-primary">Admin Login</h2>
            <div class="bg-white p-6 rounded-2xl shadow-md border">
                <div class="mb-4"><label class="text-xs font-bold uppercase">Email</label><div class="input-group mt-1"><input type="email" id="admin-email"></div></div>
                <div class="mb-6"><label class="text-xs font-bold uppercase">Password</label><div class="input-group mt-1"><input type="password" id="admin-password"></div></div>
                <button onclick="window.adminLogin()" class="w-full bg-primary text-white font-bold py-3 rounded-xl">Login</button>
            </div>
        </section>

    </main>

    <datalist id="locations"><option value="Palakkad"><option value="Guruvayur"><option value="Ottapalam"><option value="Thrissur"></datalist>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <script type="module">
        // Import Firebase (CDN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // YOUR CONFIGURATION (From Previous Context)
        const firebaseConfig = {
            apiKey: "AIzaSyDcWwo0m2eS1ndyC06U1G_JF1J7Y1WNlfQ",
            authDomain: "triotrack-66dd6.firebaseapp.com",
            projectId: "triotrack-66dd6",
            storageBucket: "triotrack-66dd6.firebasestorage.app",
            messagingSenderId: "994389952848",
            appId: "1:994389952848:web:659fbc330f2d660dfb0455",
            measurementId: "G-B7TMFX0F21"
        };

        // Initialize App
        let app, db, auth;
        
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Remove Loading Screen on Success
            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('db-status').innerText = "‚óè Connected to Cloud";
                document.getElementById('db-status').style.color = "#16a34a"; // Green
            }, 1500);
        } catch (e) {
            console.error(e);
            alert("Firebase Error: " + e.message);
        }

        // --- GLOBAL VARIABLES ---
        let map = null;
        let busMarker = null;
        let unsubscribeLive = null;
        let currentCategory = '';

        // FIX: Missing College DB
        window.collegesDB = {
            "Palakkad": ["GPTC Palakkad", "IPT Shoranur"],
            "Thrissur": ["GPTC Thrissur", "GPTC Kunnamkulam"]
        };

        // Static Data for Demo (Fallback)
        const busRoutesDB = [
            { id: "p1", type: "Private", stops: ["Palakkad", "Ottapalam", "Guruvayur"], buses: [{ id: "KL-55-A", start: "07:00", type: "Fast" }] },
            { id: "k1", type: "Transport", stops: ["Palakkad", "Thrissur", "Ernakulam"], buses: [{ id: "KSRTC", start: "08:00", type: "Super Fast" }] }
        ];

        // --- CORE FUNCTIONS (Attached to Window for HTML access) ---

        window.navigateTo = (viewId) => {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            const target = document.getElementById('view-' + viewId);
            if(target) target.classList.remove('hidden');
            window.scrollTo(0,0);

            // Special logic for map
            if (viewId === 'live-map') {
                initMap('KL-55-A'); 
            } else {
                if(unsubscribeLive) unsubscribeLive(); // Stop listening to save data
            }
        };

        window.selectCategory = (cat) => {
            currentCategory = cat;
            document.getElementById('search-header').innerText = `Find ${cat} Route`;
            window.navigateTo('search');
        };

        window.showBusResults = () => {
            const list = document.getElementById('results-list');
            list.innerHTML = '';
            let count = 0;
            
            // Simple filtering logic
            const from = document.getElementById('input-from').value;
            
            busRoutesDB.forEach(route => {
                if(currentCategory && route.type !== currentCategory) return;
                
                route.buses.forEach(bus => {
                    count++;
                    const div = document.createElement('div');
                    div.className = "bg-white p-5 rounded-2xl shadow-md border cursor-pointer hover:border-teal-500";
                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-lg text-primary">${bus.id}</h3>
                            <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded font-bold">LIVE TRACK</span>
                        </div>
                        <div class="text-sm text-gray-500">Tap to see map</div>
                    `;
                    div.onclick = () => window.navigateTo('live-map');
                    list.appendChild(div);
                });
            });

            document.getElementById('result-count').innerText = count;
            if(count > 0) window.navigateTo('results');
            else alert("No buses found. Try 'Palakkad' in Private category.");
        };

        window.loadColleges = () => {
            const dist = document.getElementById('district-select').value;
            const list = document.getElementById('college-list');
            list.innerHTML = '';
            
            if(window.collegesDB[dist]) {
                window.collegesDB[dist].forEach(c => {
                    list.innerHTML += `<div class="bg-white p-4 rounded-xl border font-bold text-gray-700">${c}</div>`;
                });
            }
        };

        window.adminLogin = async () => {
            const e = document.getElementById('admin-email').value;
            const p = document.getElementById('admin-password').value;
            try {
                await signInWithEmailAndPassword(auth, e, p);
                alert("Login Successful!");
            } catch(err) { alert(err.message); }
        };

        // --- MAP LOGIC (Leaflet + Firebase) ---
        function initMap(busId) {
            if (!map) {
                map = L.map('map', { zoomControl: false }).setView([10.7867, 76.6548], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map);
                
                // Custom Icon
                const busIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: "<div class='bus-marker-icon'>üöå</div>",
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
                busMarker = L.marker([10.7867, 76.6548], {icon: busIcon}).addTo(map);
            }

            // Real-time Listener
            if(unsubscribeLive) unsubscribeLive();
            
            const docRef = doc(db, "live_locations", busId);
            unsubscribeLive = onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const d = doc.data();
                    const latlng = [d.lat, d.lng];
                    busMarker.setLatLng(latlng);
                    map.flyTo(latlng, 15);
                    document.getElementById('map-bus-id').innerText = `Bus ${busId} ‚Ä¢ ${Math.round(d.speed * 3.6 || 0)} km/h`;
                }
            });

            // Fix map rendering issue when un-hiding
            setTimeout(() => map.invalidateSize(), 300);
        }

        // --- CLOCK ---
        setInterval(() => {
            const now = new Date();
            document.getElementById('live-time').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            document.getElementById('live-date').innerText = now.toLocaleDateString();
        }, 1000);

    </script>
</body>
</html>
